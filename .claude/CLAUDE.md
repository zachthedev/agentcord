# Agentcord

Discord Rich Presence daemon for agentic coding tools.

## Architecture

Two-part system:
1. **Hook scripts** capture session data from the coding tool (Claude Code, Cursor, etc.)
2. **Daemon** watches `state.json` and publishes to Discord via IPC

Data flow:
```
Hook event → dispatch.ts → platform script (bash/ps1) → state.json → daemon → Discord IPC
```

## Build & Test

```bash
make build          # Build daemon binary
make test           # Go tests
make test-sh        # BATS tests (Unix hook scripts)
make test-ps1       # Pester tests (Windows hook scripts)
make test-ts        # Bun tests (dispatch.ts)
make test-all       # Go + BATS + Bun
make lint           # golangci-lint
make generate       # go generate (constants, config)
make generate-assets # Regenerate Discord tier icons
```

Always run `go generate ./...` after changing:
- Path constants in `internal/paths/paths.go`
- Config struct/defaults in `internal/config/config.go`
- State version in `internal/session/state.go`

## Key Packages

| Package | Purpose |
|---------|---------|
| `cmd/agentcord` | Daemon entry point, main loop, Discord lifecycle |
| `cmd/genconfig` | Generates `config.default.toml` from Go structs |
| `cmd/genhooks` | Generates `constants.sh` and `constants.ps1` |
| `internal/config` | TOML config loading, defaults, client registry |
| `internal/session` | State file I/O, JSONL parsing, activity building, watcher |
| `internal/discord` | Discord IPC client (Unix socket / Windows named pipe) |
| `internal/pricing` | Model pricing with triple fallback (remote → cache → embedded) |
| `internal/tiers` | Model tier icons with triple fallback |
| `internal/paths` | Central path constants (data dir, state file, PID, etc.) |
| `internal/remote` | GitHub release checking for self-update |
| `internal/atomicfile` | Atomic file writes via temp + rename |
| `internal/logger` | slog-based file logger with rotation |
| `internal/migrate` | Schema versioning and migration framework |

## Generated Files (DO NOT EDIT)

- `config.default.toml` — generated by `cmd/genconfig`
- `scripts/hooks/lib/unix/constants.sh` — generated by `cmd/genhooks`
- `scripts/hooks/lib/windows/constants.ps1` — generated by `cmd/genhooks`

## State File Schema

Written by hook scripts to `~/.agentcord/state.{client}.json`:

```json
{
  "$version": 1,
  "sessionId": "abc-123",
  "sessionStart": 1700000000,
  "lastActivity": 1700000060,
  "project": "my-project",
  "branch": "main",
  "cwd": "/path/to/project",
  "gitRemoteUrl": "https://github.com/user/repo",
  "client": "claude-code",
  "stopped": false,
  "toolName": "Edit",
  "toolTarget": "/path/to/file.ts",
  "activeFile": "/path/to/file.ts",
  "agentState": "tool",
  "permissionMode": "acceptEdits",
  "hookEvent": "PreToolUse"
}
```

## Adding a Config Field

1. Add the field to the appropriate struct in `internal/config/config.go`
2. Set its default in the `DefaultConfig()` function
3. Add documentation in `internal/config/config_docs.go`
4. Run `go generate ./internal/config/...`
5. Verify `config.default.toml` reflects your changes

## Adding a New Tool Integration

See `clients/_template/README.md` for a step-by-step guide.

Summary:
1. Choose a client ID matching `^[a-z][a-z0-9]*(-[a-z0-9]+)*$`
2. Add to `knownClients` map in `internal/config/config.go`
3. Add session ID field mapping in `scripts/hooks/lib/unix/common.sh` and `common.ps1`
4. Create `clients/{tool}/` directory with README
5. Write state to `~/.agentcord/state.{client-id}.json`

## Template Variables

Format strings in `config.toml` support these variables:

| Variable | Description |
|----------|-------------|
| `{project}` | Project name |
| `{branch}` | Git branch |
| `{model}` | Model name (supports `:short`, `:full`, `:raw`) |
| `{cost}` | API cost in USD |
| `{tokens}` | Total tokens (supports `:short`, `:full`) |
| `{tool}` | Current tool name |
| `{tool_target}` | Tool target (supports `:basename`, `:dir`) |
| `{file}` | Active file (supports `:basename`, `:dir`, `:ext`) |
| `{agent_state}` | Agent state: thinking, tool, waiting, idle |
| `{client}` | Client display name |
| `{turns}` | Conversation turn count |
| `{input_tokens}` | Input tokens only |
| `{output_tokens}` | Output tokens only |
| `{cache_tokens}` | Cache tokens |
| `{git_owner}` | Repository owner |
| `{git_repo}` | Repository name |

## Error Handling

- Hook scripts are non-fatal — failures logged to stderr, never block the host tool
- Triple fallback for pricing and tiers: remote API → local cache → embedded defaults
- State file corruption: backed up to `.corrupted`, fresh state written
- Atomic file writes prevent partial reads

## Common Pitfalls

- Forgetting `go generate ./...` after changing paths or config → stale constants
- Editing generated files directly → changes overwritten on next generate
- Using `set -e` in hook scripts → breaks non-fatal contract
- TOML tag mismatch → config field silently ignored
- Client IDs use hyphens (`claude-code`), Discord asset keys use underscores (`claude_code`)

## Release Process

Uses release-please for versioning + goreleaser for cross-platform binaries.
